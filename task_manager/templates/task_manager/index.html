<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Gestor de Tareas</title>
    <script src="https://unpkg.com/htmx.org@1.9.5"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
  </head>
  <body class="container py-5">
    <h1 class="mb-4">Mis Tareas</h1>

    <!-- Botón para crear nueva tarea -->
    <button
      class="btn btn-primary mb-3"
      hx-get="{% url 'task_create' %}"
      hx-target="#modal-body"
      hx-trigger="click"
    >
      + Nueva tarea
    </button>

    <form method="get" class="row g-2 mb-4">
      <div class="col-auto">
        <input
          type="date"
          name="created_at"
          class="form-control"
          value="{{ request.GET.created_at }}"
        />
      </div>
      <div class="col-auto">
        <input
          type="text"
          name="q"
          class="form-control"
          placeholder="Buscar por contenido"
          value="{{ request.GET.q }}"
        />
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-outline-primary">Filtrar</button>
      </div>
    </form>

    <!-- Lista de tareas -->
    <div id="task-list" hx-trigger="load" hx-swap="innerHTML">
      {% for task in tasks %} {% include "task_manager/task_item.html" %}
      {% endfor %}
    </div>

    <!-- Modal para formulario de creación/edición -->
    <div
      class="modal fade"
      id="modal"
      tabindex="-1"
      style="display: none"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body" id="modal-body">
            <!-- Aquí se inyecta el formulario -->
          </div>
        </div>
      </div>
    </div>

    <!-- Fondo del modal (para estilo fade) -->
    <div
      id="modal-backdrop"
      class="modal-backdrop fade"
      style="display: none"
    ></div>

    <script>
      document.body.addEventListener("htmx:afterSwap", (e) => {
        if (e.detail.target.id === "modal-body") {
          document.getElementById("modal").classList.add("show");
          document.getElementById("modal").style.display = "block";
          document.getElementById("modal-backdrop").classList.add("show");
          document.getElementById("modal-backdrop").style.display = "block";
        }
      });

      document.body.addEventListener("htmx:afterRequest", (e) => {
        // Cerrar modal luego de crear/editar tarea
        if (
          e.detail.target.id === "modal-body" &&
          e.detail.xhr.response.includes("task-item")
        ) {
          document.getElementById("modal").classList.remove("show");
          document.getElementById("modal").style.display = "none";
          document.getElementById("modal-backdrop").classList.remove("show");
          document.getElementById("modal-backdrop").style.display = "none";
          document.getElementById("modal-body").innerHTML = "";
          htmx.trigger(htmx.find("#task-list"), "load"); // refrescar lista
        }
        // Refrescar lista tras eliminar tarea
        if (
          e.detail.target.classList.contains("card") &&
          e.detail.xhr.status === 204
        ) {
          htmx.trigger(htmx.find("#task-list"), "load");
        }
      });
    </script>
  </body>
</html>
